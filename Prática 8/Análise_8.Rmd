---
title: 'Prática 8: Análise de Variância'
author: "Guilherme Rodrigues"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document:
    df_print: paged
lang: "pt-BR"
---

<!-- ```{r setup, include=FALSE} -->
<!-- knitr::opts_chunk$set(echo = TRUE) -->
<!-- ``` -->
```{r}
options(encoding = "UTF-8")
#limpar a memória
rm(list = ls())
```

**1) Um estudo avaliou o marcador tumoral CA 15.3 em pacientes com diferentes tipos de câncer. **

```{r}
library(readxl)
library(ggplot2)
dados <- read_excel("dados.xlsx", sheet = "Atividade")
head(dados)
attach(dados)
```


**a) A partir das informações amostrais abaixo e com nível de significância de 0,05, há diferença dos marcadores tumorais entre os diferentes tipos de câncer?**

**Resposta:** A princípio vamos observar os boxplot, isto é, a distribuição dos biomarcadores separados por tipo de câncer.

```{r}
tapply(Marcador, Cancer, length) # número de peixes por dieta

tapply(Marcador, Cancer, mean) # media do ganho de peso por dieta

ggplot(dados, aes(x=Cancer, y=Marcador))+
        geom_boxplot() +
       labs(x="Cancer", 
       y = "Marcador Tumoral (CA 15.3)", 
       title="Marcador tumoral CA 15.3 por tipo de cancer")
```
O gráfico apresenta a distribuição do marcador tumoral CA 15.3 em pacientes com diferentes tipos de câncer: colorretal, mama, próstata e pulmão.

**Cãncer colorretal:** Apresenta valores elevados de CA 15.3, com mediana em torno de 62. Além disso, nota-se certa dispersão e a presença de outliers acima de 80 e abaixo de 45.

**Câncer de mama:** Mostra os menores valores de marcador, com mediana próxima de 45 e um intervalo interquartílico relativamente estreito, indicando maior homogeneidade. Também há a presença de outliers com valores baixos, em aproximadamente 20.

**Câncer de Próstata:** Distribui-se de forma intermediária, com mediana próxima a 50 e variabilidade moderada.

**Câncer de pulmão:** Também apresenta valores mais baixos, próximos ao grupo de mama, com mediana em torno de 43, mas com maior dispersão.

A variabilidade dentre de cada grupo não é identica, mas as diferenças de posição central já indicam que pode haver diferenças estatísticas entre os tipos de câncer. Vamos realizar o teste de hipóteses para verificar se há diferença entre as médias dos valores do marcador tumoral por tipo de câncer e construir a tabela ANOVA. 

- **Hipóteses:**
$$
\left\{\begin{array}{ll}
  H_0:\text{ as médias dos marcadores tumorais por tipo de câncer são equivalentes } (\mu_1=\mu_2=\mu_3=\mu_4),\\
  H_1:\text{ Pelo menos uma das médias difere das demais}.\\
\end{array}\right.
$$
- **Nível de significância:** $\alpha = 0.05$

- **Estatística do Teste:** Quadro ANOVA

```{r}
# variavel dependente = Cancer
# variavel independente = Marcador
modelo <- lm(Marcador ~ Cancer, data=dados) 
modelo # Ajuste do modelo linear

#Quadro de ANOVA
summary(aov(modelo)) 

#Calculando a linha de Totais da Tabela Anova
total_sum_square <- 6554+12053
total_sum_square
total_sum_mean_square <- 2184.5 + 103.9
total_sum_mean_square

# limite da regiao critica
qf(0.95, 3, 116) 
```


| Causas de variação | g.l. | Soma de Quadrados | Quadrado Médio | Estat. F (Qmtrat/Qmres) | p-valor  |
| ------------------ | ---- | ----------------- | -------------- | ----------------------- | -------- |
| Cancer             | 3    | 6554              | 2184.5         | 21.02                   | < 0.0001 |
| Resíduos           | 116  | 12053             | 103.9          |                         |          |
| **Total**          | 119  | 18607             | 2288.4         |                         |          |


A estatística F calculada é 21.02, enquanto o valor crítico da distribuição $F(3,116)$ com nível de significância 0.05 é aproximadamente 2.68.

- **Conclusão:** Com nível de significância de 0.05, há evidências estatísticas de que pelo menos uma das médias dos marcadores tumorais CA 15.3 difere entre os tipos de câncer avaliados. Além disso, dado que a estatística do teste está acima do limite crítico com nível de  significância de 0.05, isto confirma que existe tal diferença.


**b) Realize a análise de resíduos para avaliar as suposições do teste utilizado no item anterior.** 

**Resposta:** O modelo ANOVA parte do pressuposto que o erro segue uma distribuição Normal, isto é

$$Y_{ij} = \mu_i +e_{ij} $$
em que $e_{ij}~N(0,\sigma^2_e)$. Vamos realizar o teste de normalidade de Shapiro-Wilk para avaliar se os resíduos possuem distribuição Normal. 

- **Hipóteses:**
$$
\left\{\begin{array}{ll}
  H_0:\text{ residuos possuem distribuição Normal },\\
  H_1:\text{ resíduos não possuem distribuição Normal}.\\
\end{array}\right.
$$
- **Nível de significância:** $\alpha = 0.05$.

```{r}
anova <- aov(modelo) 

#anova$residuals #residuos por peixe
#anova$fitted.values # valores ajustados

shapiro.test(anova$residuals) #teste de normalidade para os residuos
```


- **Estatística do Teste:** 0.99104, p-value = 0.6299.

- **Conclusão:** com nível de significância 0.05, não rejeita-se $H_0$. Portanto os residuos não apresentam evidências de desvio de normalidade.

Podemos fazer avaliações gráficas com relação a suposição de normalidade dos resíduos. Segue que:

```{r}
#gráfico quantil-quantil
#quando mais proximo da linha reta, segue normal
# qqnorm(anova$residuals) 

#grafico ajustados vs residuos
#pontos tem variabilidade proximos entre eles
plot(anova, 1) 

#quantil-quantil, como anterior mas normalizados
plot(anova, 2) 

# os que ficaram acima e abaixo da média, 
#isto é, discrepantes (seleção das linhas, colunas)
dados[c(26,49,101),]
```
O primeiro gráfico dos valores ajustados versus os resíduos mostra os resíduos distribuídos sem tendência aparente, sugerindo homogeneidade de variâncias (homocedasticidade). O segundo gráfico (Quantil-Quantil) mostra que os pontos seguem aproximadamente a linha reta, reforçando a hipótee de normalidade dos resíduos, com três valores discrepantes nas duas caldas. Estes outliers consistem nos pacientes 901387 (colorretal), 450598 (mama) e 791271 (pulmão), com valores do marcador tumoral dados, respectivamente, por 86.7, 20.6 e 71.7.  

Vamos analisar a suposição de homocedasticidade das observações pelo teste Bartllet, dado que os resíduos seguem aproximadamente uma distribuição Normal. 

- **Hipóteses:**
$$
\left\{\begin{array}{ll}
  H_0:\text{ a variabilidade é semelhante entre os tipos de câncer},\\
  H_1:\text{ a variabilidade difere entre os tipos de câncer}.\\
\end{array}\right.
$$
- **Nível de significância:**  $\alpha = 0.05$.

```{r}
bartlett.test(Marcador~Cancer, data=dados)
```
- **Estatística do teste:**  0.34736, p-valor = 0.9509

-**Conclusão:** Com nível de significância de 0.05, não rejeita-se $H_0$. Isso indica que não há evidências de heterogeneidade de variâncias; em outras palavras, a variabilidade do marcador tumoral CA 15.3 é semelhante entre os diferentes tipos de câncer.


**c) Verifique em quais tipos de câncer há diferença significativa dos marcadores tumorais, com nível de significância de 0,05.**

**Resposta:** Vamos fazer comparações multiplas utilizando o teste Tukey, com o objetivo de identificar em quais tipos de câncer há diferença significativa dos marcadores tumorais.

- **Hipóteses:**
$$
\left\{\begin{array}{ll}
  H_0: \mu_i=\mu_j\text{ (não há diferença entre as médias dos grupos i e j)},\\
  H_1: \mu_i\neq \mu_j\text{ (as médias dos grupos i e j são diferentes)}.\\
\end{array}\right.
$$


```{r}
TukeyHSD(anova)
```
Resultados do teste de Tukey (comparações par a par com $\alpha$ = 0,05).

| Comparação            | Hipótese nula ((H_0))                               | p-valor | Decisão (($\alpha=0.05$))              |
| --------------------- | -------------------------------------------------   | ------- | ------------------------------------   |
| Mama – Colorretal     | ($\mu_{\text{Mama}} = \mu_{\text{Colorretal}}$)     | < 0.001 | Rejeita-se ($H_0$) (diferença)         |
| Próstata – Colorretal | ($\mu_{\text{Próstata}} = \mu_{\text{Colorretal}}$) | 0.0035  | Rejeita-se ($H_0$) (diferença)         |
| Pulmão – Colorretal   | ($\mu_{\text{Pulmão}} = \mu_{\text{Colorretal}}$)   | < 0.001 | Rejeita-se ($H_0$) (diferença)         |
| Próstata – Mama       | ($\mu_{\text{Próstata}} = \mu_{\text{Mama}}$)       | 0.0165  | Rejeita-se ($H_0$) (diferença)         |
| Pulmão – Mama         | ($\mu_{\text{Pulmão}} = \mu_{\text{Mama}}$)         | 0.9562  | Não se rejeita ($H_0$) (sem diferença) |
| Pulmão – Próstata     | ($\mu_{\text{Pulmão}} = \mu_{\text{Próstata}}$)     | 0.0034  | Rejeita-se ($H_0$) (diferença)         |

Os resultados indicam que o câncer Colorretal apresentou valores médios de CA 15.3 significativamente superiores em relação a todos os outros grupos. O câncer de Próstata apresentou valores intermediários, significativamente maiores que os de Mama e Pulmão, mas inferiores aos de Colorretal. Por fim, não houve diferença significativa entre os grupos Mama e Pulmão.

```{r}
par(mar = c(5, 12, 4, 2)) 
plot(TukeyHSD(anova), las = 1, cex.axis = 1.2, cex.lab = 1.3)

```

O gráfico mostra os intervalos de confiança de 95% para as diferenças de médias do marcador tumoral CA 15.3 entre os tipos de câncer, obtidos pelo teste de Tukey. Diferenças cujos intervalos não cruzam a linha zero são estatisticamente significativas. Observa-se que o câncer colorretal apresenta valores médios superiores aos demais, o câncer de próstata apresenta valores intermediários (maiores que mama e pulmão, porém menores que colorretal) e não há diferença significativa entre mama e pulmão.

```{r}
# mostrando a tabela do teste de Tukey com agrolab
library(agricolae)
tukey <- HSD.test(modelo, "Cancer", group=TRUE)
tukey$groups
tukey$statistics
```


| Tipo de câncer | Média CA 15.3 | Grupo |
| -------------- | ------------- | ----- |
| Colorretal     | 61.72667      | a     |
| Próstata       | 52.48667      | b     |
| Mama           | 44.55667      | c     |
| Pulmão         | 43.21000      | c     |

As tabelas mostram o agrupamento de médias pelo teste de Tukey com nível de significância de 0.05 e utilizando a biblioteca agrolab. Os resultados evidenciam que o câncer colorretal apresentou valores médios signficativamente mais elevados do marcador quando comparado a todos os demais tipos de câncer, constituindo um grupo isolado denotado pela letra a. O grupo com câncer de próstata apresentou média intermediária, significativamente superior às médias de mama e pulmão, mas inferior à de colorretal, formando um segundo grupo distinto denotado pela letra b. Finalmente, os grupos mama e pulmão não apresentam diferença estatística significativa entre si, agrupando-se na mesma categoria denotada pela letra c. 

Portanto, o teste de comparações múltiplas corrobora que existem diferenças estatisticamente significativas entre os tipos de câncer avaliados, em especial pelo maior nível do marcador observado no câncer colorretal e pelas diferenças intermediárias observadas no câncer de próstata em relação aos demais grupos. 


Também podemos utilizar os testes de Bonferroni e Dunnet: 

```{r}
pairwise.t.test(Marcador, Cancer, p.adjust.method="bonferroni")

library(DescTools)

# Aqui "Mama" é o grupo de referência (controle)
DunnettTest(x = Marcador, g = as.factor(Cancer), control = "Mama")

```

Os teste t pareado com ajuste de Bonferroni corroborou os resultados do teste Tukey, em que, apenas os cânceres de pulmão e mama não apresentam diferenças estatisticamente significativas, com p-valor = 1.00. O teste de Dunnett, considerando Mama como controle, mostrou que apenas Pulmão não apresentou diferença significativa em relação a esse grupo.
